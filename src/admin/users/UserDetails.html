<section>
    <h4>{ user.email }</h4>

    <form class="form-horizontal" on:submit="save(event)">
        <ControlGroup label="#">
            <span class="value">{user.id}</span>
        </ControlGroup>

        <ControlGroup label="{__('name', 'admin-users')}">
            <input type="text" bind:value="updates.name" />
        </ControlGroup>

        <ControlGroup label="{__('email', 'admin-users')}">
            <input type="text" bind:value="updates.email" />
        </ControlGroup>

        <ControlGroup label="{__('status', 'admin-users')}">
            <select name="role" bind:value="updates.role">
                {#each roleOptions as role}
                <option value="{role.slug}" selected="{user.role === role.slug}">
                    {__(role.name, 'admin-users')}
                </option>
                {/each}
            </select>
        </ControlGroup>

        <ControlGroup label="{__('charts', 'admin-users')}">
            <a class="value" href="/admin/chart/by/{ user.id }">{user.chartCount}</a>
        </ControlGroup>

        <ControlGroup label="{__('created-at', 'admin-users')}">
            <span class="value">{createdAtFormatted}</span>
        </ControlGroup>

        <ControlGroup label="{__('password-reset', 'admin-users')}">
            <div class="token-block">
                {#if user.resetPasswordToken}
                <code class="token">{passwordResetLink}</code>
                {/if}
                <input type="text" bind:value="resetPasswordToken" placeholder="optional: one-time password" />
                <button type="button" on:click="resetPassword()" class="btn btn-default">
                    {__('password-reset / send', 'admin-users')}
                </button>
            </div>
        </ControlGroup>

        {#if user.activateToken}
        <ControlGroup label="{__('activation-token', 'admin-users')}">
            <div class="token-block">
                <code class="token">{user.activateToken}</code>
                <button type="button" on:click="resendActivation()" class="btn btn-default">
                    {__('activation-token / send', 'admin-users')}
                </button>
            </div>
        </ControlGroup>
        {/if}

        <ControlGroup label="{__('status', 'admin-users')}">
            <div class="controls-submit">
                <button type="submit" class="btn btn-primary" data-test="save">
                    {__('actions / save', 'admin-users')}
                </button>
                <button type="button" class="btn btn-default" on:click="close()" data-test="close">
                    {__('actions / cancel', 'admin-users')}
                </button>
            </div>
        </ControlGroup>
    </form>
</section>

<style>
    .value {
        padding: 0.35em;
        display: inline-block;
    }

    .token-block {
        margin: 0.35em 0;
    }

    .token {
        margin: 0.35em 0;
        padding: 0.5em 1em;
        display: block;
    }

    .controls-submit button {
        margin: 0.35em 0.35em 0 0;
    }
</style>

<script>
    import { __ } from '../../shared/l10n';
    import moment from 'moment';
    import { ControlGroup } from '@datawrapper/controls';

    const { protocol, host } = window.location;

    export default {
        components: {
            ControlGroup
        },

        data: () => ({
            resetPasswordToken: '',
            user: {},
            updates: {}
        }),

        computed: {
            role: ({ user, roleOptions }) => roleOptions.find(({ slug }) => slug === user.role),
            createdAtFormatted: ({ user }) => moment(user.createdAt).format(__('YYYY-MM-DD, hh:mm a', 'admin-users')),
            passwordResetLink: ({ user }) => `${protocol}//${host}/account/reset-password/${encodeURI(user.resetPasswordToken)}`
        },

        helpers: {
            __
        },

        methods: {
            close() {
                this.fire('close');
            },

            save(event) {
                event.preventDefault();
                const { user, updates } = this.get();
                const changes = Object.keys(user).reduce((diff, key) => {
                    if (updates[key] !== user[key]) {
                        diff[key] = updates[key];
                    }
                    return diff;
                }, {});

                this.set({ edit: false, user: updates });
                this.fire('save', { userId: user.id, changes });
            },

            resetPassword() {
                const { user, resetPasswordToken } = this.get();
                this.fire('resetPassword', {
                    email: user.email,
                    token: resetPasswordToken
                });
            },

            resendActivation() {
                const { user } = this.get();
                this.fire('resendActivation', { email: user.email });
            }
        },

        oncreate() {
            // clone original user & token data:
            const { user } = this.get();

            this.set({
                updates: Object.assign({}, user)
            });
        }
    };
</script>
