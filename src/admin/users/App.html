<div>
    {#if userDetails}
    <UserDetails
        {roleOptions}
        user="{userDetails}"
        on:close="closeDetails()"
        on:save="saveUser(event)"
        on:resetPassword="resetPassword(event)"
        on:resendActivation="resendActivation(event)"
    ></UserDetails>
    {:else}
    <div>
        <UserTable {columnHeaders} on:sort="sort(event)">
            {#each list as user}
            <UserTableRow {user} {roleOptions} on:navigate="showDetails(event)" on:save="saveUser(event)"></UserTableRow>
            {/each}
        </UserTable>
        {#if paginationItems.length > 0}
        <div class="pull-right">
            <Pagination pages="{paginationItems}" on:navigate="gotoPage(event)" {currentPageNum}></Pagination>
        </div>
        {/if}
    </div>
    {/if}
</div>

<script>
    import { parse, stringify } from 'query-string';
    import { __ } from '../../shared/l10n';
    import { getJSON, patchJSON } from '../../shared/utils';
    import UserDetails from './UserDetails.html';
    import UserTable from './Table.html';
    import UserTableRow from './TableRow.html';
    import Pagination from './Pagination.html';

    const API_BASE_PATH = '/v3';

    export default {
        components: {
            UserDetails,
            UserTable,
            UserTableRow,
            Pagination
        },

        data: () => ({
            list: [],
            orderBy: 'id',
            loader: null,
            offset: 0,
            limit: 10,
            total: 0,
            currentUser: null,
            userDetails: null
        }),

        computed: {
            currentPageNum: ({ limit, offset }) => Math.ceil(offset / limit),
            paginationItems: ({ total, limit, offset }) =>
                Array.from({ length: Math.ceil(total / limit) }, (v, i) => ({
                    state: { limit, offset: i * limit }
                })),
            baseUrl: ({ api_domain }) => `//${api_domain}${API_BASE_PATH}`
        },

        helpers: {
            __,
            columnHeaders: [
                { width: '9%', name: '#', orderBy: 'id', className: 'col-num' },
                { width: '12%', name: __('name', 'admin-users'), orderBy: 'name' },
                { width: '20%', name: __('email', 'admin-users'), orderBy: 'email' },
                { width: '15%', name: __('status', 'admin-users') },
                { width: '15%', name: __('teams', 'admin-users') },
                { width: '18%', name: __('created-at', 'admin-users'), orderBy: 'createdAt' },
                { width: '05%', name: __('charts', 'admin-users'), className: 'col-num' },
                { width: '06%', name: __('actions', 'admin-users'), className: 'col-num' }
            ],
            roleOptions: [
                { name: 'role / admin', slug: 'admin', icon: 'fire' },
                { name: 'role / editor', slug: 'editor', icon: 'user' },
                { name: 'role / pending', slug: 'pending', icon: 'user' }
            ]
        },

        methods: {
            update({ offset, orderBy, currentUser, userDetails }) {
                this.set({ offset, orderBy, currentUser, userDetails });
                if (currentUser) {
                    this.loadUser();
                } else {
                    this.loadUserList();
                }
            },

            sort(orderBy) {
                this.set({ orderBy, offset: 0 });
                const state = { orderBy };
                window.history.pushState(state, '', `?${stringify(state)}`);
                this.loadUserList();
            },

            gotoPage({ offset, limit }) {
                this.set({ offset, limit });
                const { orderBy } = this.get();
                const state = { offset, limit, orderBy };
                window.history.pushState(state, '', `?${stringify(state)}`);
                this.loadUserList();
            },

            showDetails(currentUser) {
                this.set({ currentUser });
                window.history.pushState({ currentUser }, '', `?currentUser=${currentUser}`);
                this.loadUser();
            },

            closeDetails() {
                const { orderBy, offset, limit } = this.get();
                const state = { orderBy, offset, limit, currentUser: null, userDetails: null };
                window.history.pushState(state, '', `?${stringify(state)}`);
                this.set(state);
            },

            loadUserList() {
                const { offset, limit, orderBy, baseUrl } = this.get();
                const loader = getJSON(`${baseUrl}/users?${stringify({ offset, limit, orderBy })}`, data => {
                    if (data && data.list) {
                        const { total, list } = data;
                        this.set({ list, total });
                    }
                });
                this.set({ loader });
            },

            loadUser() {
                const { currentUser, baseUrl } = this.get();
                getJSON(`${baseUrl}/users/${currentUser}`, data => {
                    if (data) this.set({ userDetails: data });
                });
            },

            saveUser({ userId, changes }) {
                const body = JSON.stringify(changes, (key, value) => {
                    if (value === null) {
                        return undefined; // do not pass `null` (`null` means value not set)
                    } else if (value === '') {
                        return null; // pass `null` to set value to empty string
                    } else {
                        return value;
                    }
                });

                const { baseUrl } = this.get();

                patchJSON(`${baseUrl}/users/${userId}`, body)
                    .then(() => {
                        this.loadUserList();
                        this.closeDetails();
                    })
                    .catch(err => {
                        console.error(err);
                    });
            },

            resetPassword({ email, token }) {
                const body = JSON.stringify({ email, token }, (key, value) => value || undefined);
                const { baseUrl } = this.get();

                window
                    .fetch(`${baseUrl}/auth/reset-password`, {
                        method: 'POST',
                        credentials: 'include',
                        body
                    })
                    .then(() => {
                        this.loadUser();
                    })
                    .catch(err => {
                        console.error(err);
                    });
            },

            resendActivation({ email }) {
                const { baseUrl } = this.get();

                window
                    .fetch(`${baseUrl}/auth/resend-activation`, {
                        method: 'POST',
                        credentials: 'include',
                        body: JSON.stringify({ email })
                    })
                    .then(() => {
                        this.loadUser();
                    })
                    .catch(err => {
                        console.error(err);
                    });
            }
        },

        oncreate() {
            const { offset, orderBy, currentUser } = parse(window.location.search);
            this.update({ offset, orderBy, currentUser });
            window.onpopstate = ({ state }) => this.update(state);
        }
    };
</script>
